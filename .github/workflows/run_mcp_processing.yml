name: Process MCP Repositories

on:
  workflow_dispatch: # Allows manual triggering from the Actions tab
    inputs:
      target_org:
        description: 'Target GitHub organization to fork into (optional)'
        required: false
        default: 'mcp-research' # Default from script
  schedule:
    - cron: '0 3 * * 1' # Run every Monday at 3 AM UTC
  push:
    paths:
      - src/**
      - .github/workflows/run_mcp_processing.yml

jobs:
  process_repos:
    runs-on: ubuntu-latest
    # Permissions might need adjustment based on GitHub App setup and required actions
    permissions:
      contents: read # For checkout
      # Add other permissions if the workflow needs to interact with secrets or the API directly

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Use a specific Python version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else echo "requirements.txt not found"; exit 1; fi

      - name: Run MCP Repo Processing Script
        env:
          GH_APP_ID: ${{ secrets.GH_APP_ID }} # Store App ID as a repository/organization secret
          GH_APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }} # Store Private Key as a repository/organization secret
          # Use the input if manually triggered, otherwise the script uses its internal default
          TARGET_ORG_INPUT: ${{ github.event.inputs.target_org }}
        run: |
          TARGET_ORG_ARG=""
          # Only add the argument if the input is not empty and not the default (to let the script handle the default)
          if [[ -n "$TARGET_ORG_INPUT" && "$TARGET_ORG_INPUT" != "mcp-research" ]]; then
            TARGET_ORG_ARG="--target-org $TARGET_ORG_INPUT"
          fi
          echo "Running script with arguments: $TARGET_ORG_ARG"
          python src/process_mcp_repos.py $TARGET_ORG_ARG

