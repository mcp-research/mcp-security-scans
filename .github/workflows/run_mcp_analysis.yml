name: Analyze MCP Repositories

on:
  workflow_dispatch:
    inputs:
      target_org:
        description: 'Target GitHub organization to analyze (optional)'
        required: false
        default: 'mcp-research' # Default from script
      num_repos:
        description: 'Number of repositories to analyze (optional)'
        required: false
        default: '10' # Default for workflow runs
      verbose:
        description: 'Enable verbose logging'
        required: false
        type: boolean
        default: false

  schedule:
    - cron: '0 5 * * *' # Run every day at 5 AM UTC

  pull_request:
    branches:
      - main

  push:
    paths:
      - src/analyze.py
      - .github/workflows/run_mcp_analysis.yml

jobs:
  analyze_repos:
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    runs-on: ubuntu-latest
    permissions:
      contents: read # For the checkout action
      issues: write # For reading and creating issues on MCP analysis failures
    env:
      # Use 50 repos for push/PR triggers, 500 for scheduled runs
      DEFAULT_NUMBER_OF_REPOS: ${{ (github.event_name == 'push' || github.event_name == 'pull_request') && '50' || '500' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Setup virtual environment and install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt

      - name: Run MCP Repository Analysis Script
        env:
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          GH_APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Use the input if manually triggered, otherwise the script uses its internal default
          TARGET_ORG_INPUT: ${{ github.event.inputs.target_org }}
          NUM_REPOS_INPUT: ${{ github.event.inputs.num_repos }}
        run: |
          # Activate the virtual environment
          source venv/bin/activate

          # Start with an empty array for arguments
          PY_ARGS=()

          # Only add the argument if the input is not empty and not the default
          if [[ -n "$TARGET_ORG_INPUT" && "$TARGET_ORG_INPUT" != "mcp-research" ]]; then
            PY_ARGS+=( --target-org "$TARGET_ORG_INPUT" )
          fi

          # Add the number of repos argument
          PY_ARGS+=( --num-repos "${NUM_REPOS_INPUT:-$DEFAULT_NUMBER_OF_REPOS}" )

          # Add verbose flag if selected
          if [[ "${{ github.event.inputs.verbose }}" == "true" ]]; then
            PY_ARGS+=( --verbose )
          fi

          echo "Running analysis script with arguments: [${PY_ARGS[*]}]"
          python -m src.analyze "${PY_ARGS[@]}"
